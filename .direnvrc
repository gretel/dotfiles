#!/usr/bin/env bash
#
# -*- mode: bash; coding:utf-8; tab-width: 4; indent-tabs-mode: nil; -*-
# https://github.com/gretel/automagic
# tom hensel <github@jitter.eu> 2016

_check_exec() {
    if ! test -x "$1"; then
        log_error "â§„ file '${1}' is expected to be executable."; return 1;
    fi
}

use_homebrew() {
    local hb_path="$1"
    PATH_add "$hb_path/bin"
    export HOMEBREW_PATH="$hb_path"
    local hb_sbin="$hb_path/sbin"
    test -d "$hb_sbin" && PATH_add "$hb_sbin"
}

use_bundler() {
    local bundler_dir="$1"
    local bundler_bin_dir="$bundler_dir/bin"
    _check_exec "$bundler_bin_dir/bundler" || return 1;
    export BUNDLE_BIN="$bundler_bin_dir"
    PATH_add "$bundler_bin_dir"
}

# TODO: sync with direnv.stdlib
use_node() {
    local node_path="$1"
    local modules_path="$node_path/.node_modules"
    local bin_path="$modules_path/.bin"

    export NODE_HOME="$node_path"
    export NODE_PATH="$modules_path"
    PATH_add "$bin_path"
}

# TODO: sync with direnv.stdlib
use_go() {
    local go_dir="$1"
    local go_path="$go_dir/.go"
    export GOPATH="$go_path"
    local go_path_bin="$go_dir/.go/bin"
    PATH_add "$go_path_bin"
    local go_bin_dir="$PREFIX/opt/go/libexec/bin"
    _check_exec "$go_bin_dir/go" || return 1;
    PATH_add "$go_bin_dir"
}

use_ansible() {
    local ansible_path="$1"
    export ANSIBLE_HOME="$ansible_path"
    local script="$ansible_path/hacking/env-setup"
    _check_exec "$script" || return 1;
    # shellcheck source=/dev/null
    source "$script" > /dev/null
}

###
### # direnv
###

# prevent logging for now, will be enabled again later  by automagic
export DIRENV_LOG_FORMAT=

### these will be in global use
### - argument: installation prefix
use homebrew "${PREFIX-/usr/local}"
use go "${HOME}"
#use node "${HOME}"

###
### # automagic
###

use_auto() {
    local autofile="$(brew --prefix autobitch)/share/autobitch.sh"
    if test -f "$autofile"; then
        source_env "$autofile"
        auto_log_prefix "$(expand_path "$1")"
    fi
}
